<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>{{ title or "Encryption App" }}</title>
    {{ base_css|safe }}
  </head>
  <body>
    <div class="topbar">
      <div class="topbar-inner">
        <div class="links">
          <a href="{{ url_for('index') }}">Encrypt</a>
          <a href="{{ url_for('decrypt') }}">Decrypt</a>
          <a href="{{ url_for('inbox') }}">Inbox</a>
          <a href="{{ url_for('profile') }}">Profile</a>
          <a href="{{ url_for('admin') }}">Admin</a>
          <a href="{{ url_for('logout') }}">Logout</a>
        </div>
        <div class="muted">
          {% if session.get('username') %}
            Logged in as <strong>{{ session.get('username') }}</strong>
          {% endif %}
        </div>
        <div class="theme-picker" id="themePicker">
          <button class="theme-button" id="themeToggle" type="button">
            Theme
          </button>
          <div class="theme-menu" id="themeMenu">
            <button data-theme="hacker">Hacker</button>
            <button data-theme="modern">Modern</button>
            <button data-theme="light">Light</button>
            <button data-theme="retro">Retro</button>
            <button data-theme="futuristic">Futuristic</button>
            <button data-theme="instagram">Instagram</button>
            <button data-theme="facebook">Facebook</button>
          </div>
        </div>
      </div>
    </div>

    <div class="container stack">
      {% block content %}{% endblock %}
    </div>

    <script>
      (function () {
        const menu = document.getElementById('themeMenu');
        const toggle = document.getElementById('themeToggle');
        const picker = document.getElementById('themePicker');

        if (!menu || !toggle || !picker) return;

        toggle.addEventListener('click', function () {
          menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        });

        window.addEventListener('click', function (e) {
          if (!picker.contains(e.target)) {
            menu.style.display = 'none';
          }
        });

        function applyTheme(name) {
          if (name && name !== 'hacker') {
            document.documentElement.setAttribute('data-theme', name);
          } else {
            document.documentElement.removeAttribute('data-theme');
          }
        }

        fetch('{{ url_for("get_theme") }}')
          .then(function (r) { return r.json(); })
          .then(function (j) { applyTheme(j.theme); })
          .catch(function () { /* ignore */ });

        Array.prototype.forEach.call(
          menu.querySelectorAll('button'),
          function (btn) {
            btn.addEventListener('click', function () {
              const theme = this.getAttribute('data-theme');
              fetch('{{ url_for("set_theme") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ theme: theme })
              }).then(function (r) {
                if (r.ok) applyTheme(theme);
                menu.style.display = 'none';
              }).catch(function () {
                applyTheme(theme);
                menu.style.display = 'none';
              });
            });
          }
        );
      })();
    </script>
  </body>
</html>


